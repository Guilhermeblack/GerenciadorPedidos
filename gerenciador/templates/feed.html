{% extends "blocks/base.html" %}
{% load static %}
{% block content %}

    <script type="text/javascript">

       $(document).on("click",".close-filho",function() {
            $(this).parents().find('.mod-filho').modal('hide');
<!--            $('#comanda_cli').modal('hide');-->
         });
    $(document).ready(function(){

        $('.card-body').each(function(){
            let id = $(this).attr("id");
            let stat = $(this).siblings().find('.active').text().trim();

            color_bg(stat, id);
        });

    });
    function color_bg(stat, id){
        switch (stat) {
            case "Pedido realizado":
                $('#'+id).css('background-color','#D8FBDA');
            break;
            case "Fazendo":
                $('#'+id).css('background-color','#F4FA8A');
            break;
            case "Saiu para entrega":
                $('#'+id).css('background-color','#ADDCF6');
            break;
            case "Foi entregue":
                $('#'+id).css('background-color','#B1FBAE ');
            break;
            case "Cancelado":

                $('#'+id).css('background-color','#ECAEAA');
            break;
            default:
                $(this).parents('.card-body').addClass('bg-transparent');
        };
    };

    $(document).on('click', '.cp',function(){
        let stat = $(this).parent().find('.status_pedido').parent('.active').prev().text().trim();
        let st='';
        switch (stat) {
            case "Pedido realizado":
                st = "P";
            break;
            case "Fazendo":
                st = "F";
            break;
            case "Saiu para entrega":
                st = "S";
            break;
            case "Foi entregue":
                st = "E";
            break;
            case "Cancelado":

                st = "C";
            break;
            default: st = "P";
        };
        let id = $(this).parent().parent().siblings('#idped').text().trim();
        let csrf = $(this).parents().find("input[name=csrfmiddlewaretoken]").val();
        if(st == "C"){
            $('#modal_cancelapedido').find('#cancela').val($('#idped').text());
            $('#modal_cancelapedido').modal('show');

        }else{


        };
        $.ajax({
            headers: { "X-CSRFToken": csrf },
            type: 'POST',
            url: "{% url 'feed' %}",
            data: {'stats' :st, 'idstat': id},
            success: function (response) {
                    location.reload();
            },
            error: function (response) {
            }
        });
        color_bg(stat, id);


    });

    $(document).on('click', '.cn',function(){
        let stat = $(this).parent().find('.status_pedido').parent('.active').next().text().trim();
        let st='';
        switch (stat) {
            case "Pedido realizado":
                st = "P";
            break;
            case "Fazendo":
                st = "F";
            break;
            case "Saiu para entrega":
                st = "S";

            break;
            case "Foi entregue":
                st = "E";

            break;
            case "Cancelado":

                st = "C";

            break;
            default: st = "P";
        };
        let id = $(this).parent().parent().siblings('#idped').text().trim();
        let csrf = $(this).parents().find("input[name=csrfmiddlewaretoken]").val();
        if(st == "C"){
            $('#modal_cancelapedido').find('#cancela').val($('#idped').text());
            $('#modal_cancelapedido').modal('show');

        }else{


        };
        $.ajax({
            headers: { "X-CSRFToken": csrf },
            type: 'POST',
            url: "{% url 'feed' %}",
            data: {'stats' :st, 'idstat': id},
            success: function (response) {
                    location.reload();
            },
            error: function (response) {
            }
        });

        color_bg(stat, id);




    });


    </script>
    {% for message in messages %}
        <div class="alert {{ message.tags }} alert-dismissible" id="msg" role="alert" style="background-color:powderblue; margin-top: 20px; padding: 10px; font-size: medium;  ">
            <button style="font-size: 22px;  align-self: right" type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            {{ message }}
        </div>
    {% endfor %}

    <header class="masthead text-white text-center " >

        <div class='base' style="align-self:center;width: auto;height: auto; margin-top: 15px;">


                <div class="row bg-white">
                    <div class="col m-5" >

                    </div>
                    <div class="col mr-4">
                        <h1 class="text-primary" style="width:90%; padding: 18px; margin-bottom:17px;">FEED</h1>
                    </div>
                    <div class="col" style="float">
                        {% if perms.gerenciador.fechar_comanda or perms.gerenciador.abrir_comanda %}
                            <button class="btn btn-primary btn-rounded hover" style=" margin-bottom:23px; margin-right:28px;align-content:right" data-toggle="modal" data-target="#comandas"><i class="icon ion-clipboard mr-2"></i><b><span>Comandas</span></b> </button>

                            <div class="modal fade" role="dialog" tabindex="-1" id="comandas" style="color: rgb(33,37,41);">
                                <div class="modal-dialog modal-lg" role="document">
                                    <div class="modal-content ">

                                        <div class="modal-header"> Comandas </h4>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                                    aria-hidden="true">×</span></button>
                                        </div>
                                        <form method="post" name="comandas">
                                            <div class="modal-body">
                                                <h6 class="modal-title">
                                                    <div class="row align-items-center">
                                                        <div class='col text-align-left font-weight-bold'>{{ 'Nº Mesa' }}</div>
                                                        <div class='col text-align-center font-weight-bold'>{{ 'Nome Cliente' }}</div>
                                                        <div class='col text-align-right font-weight-bold'>{{ 'Total Comanda' }}</div>
                                                    </div>
                                                </h6>

                                                {% for com in comandas %}
                                                    <p>
                                                    <div class='row text-align-center pb-1 hover' data-toggle="modal" data-target="#comanda_cli{{com.id}}" style="cursor: pointer;">


                                                        <div class='col text-align-left'>{{ com.n_mesa }}</div>
                                                        <div class='col text-align-center'>{{ com.nome }}</div>
                                                        <div class='col text-align-right'>{{ com.valor }}</div>
                                                    </div>
                                                    <div class="modal fade mod-filho" role="dialog" tabindex="-1" id="comanda_cli{{com.id}}" style="color: rgb(33,37,41);">
                                                        <div class="modal-dialog modal-lg" role="document">
                                                            <div class="modal-content ">

                                                                <div class="modal-header"> Pedidos </h4>
                                                                    <button type="button" class="close close-filho" data-target="comanda_cli" aria-label="Close"><span
                                                                        aria-hidden="true">×</span></button>
                                                                </div>
                                                                <form method="post" name="comanda_cli">
                                                                    <div class="modal-body">
                                                                        <h6 class="modal-title">
                                                                            <div class="row align-items-center">
                                                                                <div class='col text-align-left font-weight-bold'>{{ 'Produto' }}</div>
                                                                                <div class='col text-align-center font-weight-bold'>{{ 'quantidade' }}</div>
                                                                                <div class='col text-align-center font-weight-bold'>{{ 'Valor' }}</div>
                                                                                <div class='col text-align-right font-weight-bold'>{{ 'Status' }}</div>
                                                                            </div>
                                                                        </h6>

                                                                        {% for ped in pedidos %}
<!--                                                                            {{ ped.comandaref.id }}-->
<!--                                                                            {{ com.id }}-->
                                                                            {% if ped.comandaref.id == com.id %}


                                                                                <div class='row text-align-center pb-1 hover' style="cursor: pointer;">


                                                                                    {% for prod in ped.produtosPed.all %}
                                                                                            <div class='col text-align-left'>{{ prod.nome }}</div>
                                                                                    {% endfor %}
                                                                                    <div class='col text-align-center'>{{ ped.quantidade }}</div>
                                                                                    {% for prod in ped.produtosPed.all %}
                                                                                            <div class='col text-align-center'>{{ prod.preco }}</div>
                                                                                    {% endfor %}
                                                                                    <div class='col text-align-right'>{{ ped.status }}</div>
                                                                                </div>
                                                                            {%endif%}

                                                                        {% endfor %}
                                                                    </div>

                                                                    <div class="modal-footer">
                                                                        <button class="btn btn-warning btn-lg btn-block" type="submit" >Fechar Comanda</button>
                                                                        <button class="btn btn-danger cancel close-filho" type="button" data-target="comanda_cli"  >Sair</button>
                                                                    </div>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}

                                            </div>

                                            <div class="modal-footer">
<!--                                                <button class="btn btn-success btn-lg btn-block" type="submit" >Abrir comanda</button>-->
                                                <button class="btn btn-danger cancel" type="button" data-dismiss="modal" >Sair</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {%endif%}
                    </div>
                </div>


                {% for pedido in pedidos|dictsort:"data" %}
                    <div class="row mb-3 ">
                        <div class="col mb-2">

                            <div class="card border border-secondary rounded-top" style="color: rgb(33,37,41);">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="mb-0">Comanda - {{pedido.comandaref}}</h5>
                                </div>
                                <div class="card-body" id="bodybg{{pedido.id}}"><b>
                                    {% for ped in pedido.produtosPed.all %}
                                        <p class="card-text">{{ped.nome}} </p>
                                    {%endfor%}
                                    <p class="card-text">{{pedido.quantidade}}</p>
                                    <p class="card-text">{{pedido.observacao}}</p>
                                </b></div>
                                <hr>
                                {% csrf_token %}
                                <div id="idped" style="display: none;">{{pedido.id}}</div>
                                <div class="pb-2 bg-light mb-3">

                                    <div id="carousel{{pedido.id}}" class="carousel slide" data-interval="false" data-ride="carousel">
                                      <div class="carousel-inner">
    <!--                                    {{choices}}-->
                                        {% for choice in choices%}
    <!--                                      {{choice}}-->
                                          {% if choice == pedido.get_status_display %} <div class="carousel-item active"> {%else%} <div class="carousel-item">{% endif %}
                                            <div class="d-block status_pedido" >{{ choice }}</div>
                                            </div>



                                        {% endfor %}

                                      </div>
                                          <a class="carousel-control-prev cp" href="#carousel{{pedido.id}}" role="button" data-slide="prev">
                                            <div><i class="caret-left-square-fill dark" ></i></div>
                                              <span class="carousel-control-prev-icon bg-dark" aria-hidden="true"></span>
                                          </a>
                                          <a class="carousel-control-next cn" href="#carousel{{pedido.id}}" role="button" data-slide="next">
                                            <i class="arrow-alt-circle-right bg-dark" ></i>
                                              <span class="carousel-control-next-icon bg-dark" aria-hidden="true"></span>
                                          </a>
                                      </div>


                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                <div class="modal fade bg-danger text-danger" role="dialog" tabindex="-1" id="modal_cancelapedido">
                    <div class="modal-dialog modal-dialog-centered" role="document" >

                        <div class="modal-content bg-light">
                            <div class="modal-header">
                                <h4 class="modal-title text-light">Cancelar Pedido</h4><button type="button" class="close btn btn-light" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                            </div>
                            <div class="modal-body text-sucess">
                                <p>
                                <h2><b>Deseja mesmo cancelar este pedido ?</b></h2>
                                </p>

                                    <button type="submit" class="btn btn-sucess border btn-lg btn-block bg-warning" data-dismiss="modal" id="confirm">Confirmar</button>
                            </div>
                            <div class="modal-footer"><button id='cancel' class="btn btn-lg border btn-danger" type="button" data-dismiss="modal" onclick="naocencela()">Não cancelar</button>
                            </div>
                        </div>

                    </div>

                </div>
        </div>
    </header>

{% endblock %}
</html>